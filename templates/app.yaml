AWSTemplateFormatVersion: '2010-09-09'
Description: >
  EC2 Application Stack for 3-tier CI/CD Project.
  Deploys EC2, installs Apache, and loads webpage from GitHub repo.

Parameters:
  EnvName:
    Type: String
    Default: DEV
    Description: Environment name (DEV, TEST, PROD)

  InstanceType:
    Type: String
    Default: t3.micro

  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Default: mykeypair

  AmiId:
    Type: String
    Default: ""
    Description: "Optional â€” leave empty to auto-select AMI based on region"

  ForceUpdate:
    Type: String
    Default: "1"

Mappings:
  RegionMap:
    us-east-1:
      AMI: ami-06dd5c911c0d8dcdc
    us-west-2:
      AMI: ami-04f9aa2b7c7091927

Conditions:
  UseProvidedAmi: !Not [!Equals [!Ref AmiId, ""]]

Resources:

  ##############################################
  # Security Group
  ##############################################
  AppSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow HTTP and SSH
      VpcId: !ImportValue
        Fn::Sub: "${EnvName}-VpcId"
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub "${EnvName}-AppSecurityGroup"

  ##############################################
  # EC2 Instance
  ##############################################
  AppInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType
      ImageId: !If
        - UseProvidedAmi
        - !Ref AmiId
        - !FindInMap [RegionMap, !Ref "AWS::Region", AMI]
      KeyName: !Ref KeyName
      SubnetId: !Select
        - 0
        - !Split
          - ","
          - !ImportValue
              Fn::Sub: "${EnvName}-PublicSubnets"
      SecurityGroupIds:
        - !Ref AppSecurityGroup

      ##############################################
      # UserData: Deploy real website from GitHub
      ##############################################
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum update -y

          # Install Apache + Git
          yum install -y httpd git

          systemctl start httpd
          systemctl enable httpd

          # Clone the repo
          cd /tmp
          git clone https://github.com/anzy-anzy/cicd-3tier-cloudformation.git

          # Copy the actual index file
          cp /tmp/cicd-3tier-cloudformation/app/index.template.html /var/www/html/index.html

          # Set permissions
          chmod 644 /var/www/html/index.html

          # Restart Apache
          systemctl restart httpd

      Tags:
        - Key: Name
          Value: !Sub "${EnvName}-AppServer"
        - Key: ForceUpdate
          Value: !Ref ForceUpdate

Outputs:
  AppInstanceId:
    Value: !Ref AppInstance
    Export:
      Name: !Sub "${EnvName}-AppInstanceId"

  AppSecurityGroupId:
    Value: !Ref AppSecurityGroup
    Export:
      Name: !Sub "${EnvName}-AppSecurityGroupId"

  PublicSubnetUsed:
    Value: !Select
      - 0
      - !Split
        - ","
        - !ImportValue
            Fn::Sub: "${EnvName}-PublicSubnets"
